name: Twitch Recorder

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "نام کانال توییچ (مثال: bigezmoge)"
        required: false
  schedule:
    - cron: "*/10 * * * *"   # هر 10 دقیقه یکبار (به وقت UTC) چک می‌کند

concurrency:
  group: twitch-recorder
  cancel-in-progress: false

env:
  CHANNEL: "bigezmoge"
  GDRIVE_REMOTE: "gdrive"            # اسم remote در rclone.conf
  GDRIVE_DIR: "twitch-records"       # پوشه مقصد در گوگل‌درایو

jobs:
  record:
    runs-on: ubuntu-latest
    timeout-minutes: 720   # حداکثر 12 ساعت ضبط

    steps:
      - name: اگر کانال دستی وارد شد، همونو ست کن
        if: ${{ github.event.inputs.channel != '' }}
        run: echo "CHANNEL=${{ github.event.inputs.channel }}" >> $GITHUB_ENV

      - name: نصب ابزارها
        run: |
          sudo apt-get update
          sudo apt-get install -y streamlink ffmpeg curl
          curl https://rclone.org/install.sh | sudo bash

      - name: تنظیم rclone با Secret
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          rclone about ${GDRIVE_REMOTE}: || (echo "❌ کانفیگ rclone یا remote درست نیست" && exit 1)

      - name: ساخت پوشه خروجی
        run: mkdir -p videos

      - name: چک لایو بودن و ضبط
        run: |
          TS=$(date -u +'%Y-%m-%d_%H-%M-%S')
          OUT="videos/${CHANNEL}_${TS}.mp4"
          echo "Checking $CHANNEL ..."
          if streamlink --twitch-disable-ads https://twitch.tv/$CHANNEL best -o "$OUT"; then
            echo "🎬 Saved: $OUT"
          else
            echo "🔕 Not live. Skipping upload."
            [ -f "$OUT" ] && [ ! -s "$OUT" ] && rm -f "$OUT"
            exit 0
          fi

      - name: آپلود به Google Drive
        run: |
          DATE=$(date -u +'%Y-%m-%d')
          TIME=$(date -u +'%H-%M-%S')
          DEST_FOLDER="${GDRIVE_DIR}/${CHANNEL}/${DATE}_${TIME}"
          rclone copy --fast-list videos "${GDRIVE_REMOTE}:$DEST_FOLDER"
          echo "✅ Uploaded to $DEST_FOLDER"
          rclone ls "${GDRIVE_REMOTE}:$DEST_FOLDER" | tail -n 5
