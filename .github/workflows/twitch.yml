name: Twitch Recorder

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "Ù†Ø§Ù… Ú©Ø§Ù†Ø§Ù„ ØªÙˆÛŒÛŒÚ† (Ù…Ø«Ø§Ù„: bigezmoge)"
        required: false
  schedule:
    - cron: "*/10 * * * *"   # Ù‡Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ©Ø¨Ø§Ø± (Ø¨Ù‡ ÙˆÙ‚Øª UTC) Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯

concurrency:
  group: twitch-recorder
  cancel-in-progress: false

env:
  CHANNEL: "bigezmoge"
  GDRIVE_REMOTE: "gdrive"            # Ø§Ø³Ù… remote Ø¯Ø± rclone.conf
  GDRIVE_DIR: "twitch-records"       # Ù¾ÙˆØ´Ù‡ Ù…Ù‚ØµØ¯ Ø¯Ø± Ú¯ÙˆÚ¯Ù„â€ŒØ¯Ø±Ø§ÛŒÙˆ

jobs:
  record:
    runs-on: ubuntu-latest
    timeout-minutes: 720   # Ø­Ø¯Ø§Ú©Ø«Ø± 12 Ø³Ø§Ø¹Øª Ø¶Ø¨Ø·

    steps:
      - name: Ø§Ú¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯ØŒ Ù‡Ù…ÙˆÙ†Ùˆ Ø³Øª Ú©Ù†
        if: ${{ github.event.inputs.channel != '' }}
        run: echo "CHANNEL=${{ github.event.inputs.channel }}" >> $GITHUB_ENV

      - name: Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§
        run: |
          sudo apt-get update
          sudo apt-get install -y streamlink ffmpeg curl
          curl https://rclone.org/install.sh | sudo bash

      - name: ØªÙ†Ø¸ÛŒÙ… rclone Ø¨Ø§ Secret
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          rclone about ${GDRIVE_REMOTE}: || (echo "âŒ Ú©Ø§Ù†ÙÛŒÚ¯ rclone ÛŒØ§ remote Ø¯Ø±Ø³Øª Ù†ÛŒØ³Øª" && exit 1)

      - name: Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡ Ø®Ø±ÙˆØ¬ÛŒ
        run: mkdir -p videos

      - name: Ú†Ú© Ù„Ø§ÛŒÙˆ Ø¨ÙˆØ¯Ù† Ùˆ Ø¶Ø¨Ø·
        run: |
          TS=$(date -u +'%Y-%m-%d_%H-%M-%S')
          OUT="videos/${CHANNEL}_${TS}.mp4"
          echo "Checking $CHANNEL ..."
          if streamlink --twitch-disable-ads https://twitch.tv/$CHANNEL best -o "$OUT"; then
            echo "ğŸ¬ Saved: $OUT"
          else
            echo "ğŸ”• Not live. Skipping upload."
            [ -f "$OUT" ] && [ ! -s "$OUT" ] && rm -f "$OUT"
            exit 0
          fi

      - name: Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Google Drive
        run: |
          DATE=$(date -u +'%Y-%m-%d')
          TIME=$(date -u +'%H-%M-%S')
          DEST_FOLDER="${GDRIVE_DIR}/${CHANNEL}/${DATE}_${TIME}"
          rclone copy --fast-list videos "${GDRIVE_REMOTE}:$DEST_FOLDER"
          echo "âœ… Uploaded to $DEST_FOLDER"
          rclone ls "${GDRIVE_REMOTE}:$DEST_FOLDER" | tail -n 5
