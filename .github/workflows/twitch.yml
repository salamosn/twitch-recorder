name: Twitch Recorder

on:
  workflow_dispatch:   # Ø§Ø¬Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ø² ØªØ¨ Actions
    inputs:
      channel:
        description: "bigezmoge"
        required: false
  schedule:
    - cron: "*/10 * * * *"   # Ù‡Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡ (Ø¨Ù‡ ÙˆÙ‚Øª UTC) Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯

concurrency:
  group: twitch-recorder
  cancel-in-progress: false   # Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯

env:
  CHANNEL: "Ù†Ø§Ù…_Ú©Ø§Ù†Ø§Ù„_ØªÙˆÛŒÛŒÚ†_Ø§ÛŒÙ†Ø¬Ø§"   # ğŸ‘ˆ Ø§ÛŒÙ†Ùˆ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
  GDRIVE_REMOTE: "remote"            # Ø§Ø³Ù… remote Ú©Ù‡ ØªÙˆÛŒ rclone Ø³Ø§Ø®ØªÛŒ
  GDRIVE_DIR: "twitch-records"       # ÙÙˆÙ„Ø¯Ø± Ù…Ù‚ØµØ¯ Ø±ÙˆÛŒ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ

jobs:
  record:
    runs-on: ubuntu-latest
    timeout-minutes: 720   # Ø­Ø¯Ø§Ú©Ø«Ø± 12 Ø³Ø§Ø¹Øª Ø¶Ø¨Ø·

    steps:
      - name: Ø§Ú¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯ØŒ Ù‡Ù…ÙˆÙ†Ùˆ Ø³Øª Ú©Ù†
        if: ${{ github.event.inputs.channel != '' }}
        run: echo "CHANNEL=${{ github.event.inputs.channel }}" >> $GITHUB_ENV

      - name: Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§
        run: |
          sudo apt-get update
          sudo apt-get install -y streamlink ffmpeg rclone

      - name: ØªÙ†Ø¸ÛŒÙ… rclone Ø¨Ø§ Secret
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          rclone about ${GDRIVE_REMOTE}: || (echo "âŒ Ú©Ø§Ù†ÙÛŒÚ¯ rclone ÛŒØ§ remote Ø¯Ø±Ø³Øª Ù†ÛŒØ³Øª" && exit 1)

      - name: Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡ Ø®Ø±ÙˆØ¬ÛŒ
        run: mkdir -p videos

      - name: Ú†Ú© Ù„Ø§ÛŒÙˆ Ø¨ÙˆØ¯Ù† Ùˆ Ø¶Ø¨Ø·
        run: |
          TS=$(date -u +'%Y-%m-%d_%H-%M-%S')
          OUT="videos/${CHANNEL}_${TS}.mp4"
          echo "Checking $CHANNEL ..."
          if streamlink --twitch-disable-ads https://twitch.tv/$CHANNEL best -o "$OUT"; then
            echo "ğŸ¬ Saved: $OUT"
          else
            echo "ğŸ”• Not live. Skipping upload."
            [ -f "$OUT" ] && [ ! -s "$OUT" ] && rm -f "$OUT"
            exit 0
          fi

      - name: Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Google Drive
        run: |
          rclone copy --fast-list videos "${GDRIVE_REMOTE}:${GDRIVE_DIR}/${CHANNEL}/"
          echo "âœ… Uploaded. Recent files on Drive:"
          rclone ls "${GDRIVE_REMOTE}:${GDRIVE_DIR}/${CHANNEL}/" | tail -n 5
